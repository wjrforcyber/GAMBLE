#include "mazeRouter.hpp"
#include "sectionProcessCPU.hpp"
#include "util.hpp"
#include <cassert>
#include <vector>

using namespace std;
const int N = 43;
const int dx[] = {-1, 1, 0, 0};
const int dy[] = {0, 0, -1, 1};

void dfs(int x, int y, vector<vector<int>> &cost) {
    if(cost[x][y] != -1) return;
    cost[x][y] = 0;
    for(int d = 0; d < 4; d++) {
        int nx = x + dx[d], ny = y+ dy[d];
        if(0 <= nx && nx < N && 0 <= ny && ny < N)
            dfs(nx, ny, cost);
    }
}
int evaluate(const vector<pair<int, int>> &res, vector<vector<int>> cost, const int N) {   
    const int turnCost = 50; 
    int tot = 0;
    for(auto e : res) {
        assert(cost[e.first][e.second] != -1);
        tot += cost[e.first][e.second];
        cost[e.first][e.second] = -1;
    }
    
    int turnCount = 0;
    for(int i = 0; i < N; i++)
        for(int j = 0; j < N; j++) if(cost[i][j] == -1) {
            int test[2] = {0, 0};
            for(int d = 0; d < 4; d++) {
                int x = i + dx[d], y = j + dy[d];
                test[d / 2] |= (0 <= x && x < N && 0 <= y && y < N && cost[x][y] == -1);
            }
            turnCount += test[0] && test[1];
        }
    dfs(res[0].first, res[0].second, cost);
    tot += turnCount * turnCost;
    
    for(auto e : res) 
        if(cost[e.first][e.second] == -1) tot = -1;
    return tot;
}

int main()
{
    vector<pair<int, int>> pins = {{0,0}, {8,42}};
    vector<vector<int>> h_matrix = {
        {3, 3, 3, 3, 3, 1000000000, 1000000000, 1000000000, 1000000000, 1000000000, 1000000000, 1000000000, 1000000000, 1000000000, 1000000000, 1000000000, 1000000000, 1000000000, 3, 1, 1, 2, 7, 2, 3, 3, 2, 2, 11, 1, 3, 3, 3, 2, 5, 1, 2, 2, 131, 1, 1, 2, 3},
        {1, 2, 1, 1, 3, 1000000000, 1000000000, 1000000000, 1000000000, 1000000000, 1000000000, 1000000000, 1000000000, 1000000000, 1000000000, 1000000000, 1000000000, 1000000000, 1, 131, 1, 1, 1, 2, 19, 1, 3, 2, 1, 3, 1, 1, 1, 2, 35, 3, 2, 1, 1, 2, 3, 2, 3},
        {2, 2, 2, 67, 2, 1000000000, 1000000000, 1000000000, 1000000000, 1000000000, 1000000000, 1000000000, 1000000000, 1000000000, 1000000000, 1000000000, 1000000000, 1000000000, 2, 2, 1, 3, 2, 3, 3, 67, 3, 3, 3, 1, 67, 3, 2, 515, 11, 1, 35, 3, 1, 2, 1, 1, 1},
        {2, 3, 3, 3, 1, 1, 1, 2, 2, 1, 2, 1, 2, 1, 2, 1, 2, 3, 1, 2, 1, 3, 2, 1, 7, 1, 3, 1, 3, 3, 1, 1, 2, 1, 3, 2, 1, 1, 1, 2, 1, 515, 3},
        {3, 1, 1, 7, 5, 3, 2, 2, 2, 3, 2, 2, 1, 1, 1, 1, 1, 3, 1, 1, 1, 1, 2, 1, 2, 2, 3, 3, 3, 1, 1, 2, 2, 259, 3, 1, 1, 3, 3, 1, 3, 2, 2},
        {3, 3, 3, 2, 1, 1, 2, 3, 2, 3, 3, 2, 3, 3, 3, 3, 2, 3, 2, 3, 2, 3, 3, 3, 2, 1, 2, 1, 1, 2, 3, 3, 1, 1, 515, 1, 2, 2, 1, 3, 3, 1, 7},
        {3, 1, 3, 3, 2, 67, 515, 1, 2, 1, 1, 35, 1, 2, 3, 1, 2, 2, 2, 2, 3, 1, 2, 2, 3, 35, 2, 2, 1, 2, 2, 3, 1, 2, 3, 2, 2, 1, 3, 1, 2, 2, 2},
        {2, 3, 1, 1, 515, 19, 3, 19, 2, 2, 2, 1, 3, 3, 1, 11, 1, 19, 2, 3, 3, 1, 2, 259, 3, 3, 1, 2, 2, 3, 3, 2, 3, 1, 2, 1, 3, 3, 2, 2, 2, 1, 2},
        {2, 1, 1, 1, 1, 1, 2, 2, 3, 2, 1, 3, 1, 1, 2, 2, 2, 5, 3, 1, 1, 19, 1, 3, 3, 1, 1, 2, 1, 3, 2, 3, 35, 3, 2, 3, 35, 2, 3, 3, 67, 2, 1},
        {2, 3, 3, 1, 3, 3, 1, 3, 1, 2, 2, 3, 2, 3, 1, 2, 1, 3, 3, 2, 2, 3, 1, 3, 3, 1, 3, 3, 1, 1, 3, 3, 2, 2, 5, 3, 1, 2, 3, 2, 2, 3, 2},
        {1, 35, 2, 1, 3, 11, 2, 1, 2, 7, 3, 11, 2, 1, 3, 131, 3, 2, 3, 3, 1, 2, 2, 2, 35, 11, 2, 2, 1, 3, 1, 3, 2, 2, 1, 3, 19, 3, 3, 3, 5, 1, 1},
        {2, 2, 1, 3, 1, 3, 3, 3, 3, 3, 3, 1, 259, 2, 3, 3, 2, 2, 1, 2, 1, 3, 1, 1, 1, 259, 3, 1, 2, 2, 3, 3, 3, 1, 2, 2, 67, 3, 3, 1, 2, 3, 1},
        {2, 3, 2, 2, 1, 1, 3, 3, 2, 1, 3, 2, 3, 5, 1, 3, 3, 2, 1, 11, 3, 1, 3, 2, 3, 2, 1, 3, 2, 1, 1, 3, 1, 1, 3, 1, 1, 3, 1, 1, 3, 1, 1},
        {2, 2, 1, 1, 3, 3, 2, 1, 3, 3, 7, 67, 2, 2, 1, 3, 2, 1, 2, 3, 3, 1, 3, 1, 1, 1, 2, 1, 1, 2, 2, 19, 2, 1, 2, 2, 3, 3, 2, 1, 3, 1, 1},
        {3, 3, 3, 1, 1, 2, 1, 1, 1, 3, 2, 3, 3, 2, 1, 2, 1, 2, 131, 3, 2, 3, 2, 1, 3, 2, 2, 1, 2, 2, 2, 3, 2, 3, 1, 3, 1, 3, 1, 3, 1, 1, 2},
        {3, 1, 3, 3, 2, 2, 2, 3, 2, 1, 2, 2, 1, 1, 11, 1, 1, 3, 2, 3, 1, 1, 1, 2, 1, 2, 2, 2, 3, 2, 67, 1, 3, 3, 1, 3, 1, 2, 7, 3, 3, 2, 3},
        {7, 2, 2, 1, 3, 1, 2, 1, 3, 2, 2, 1, 2, 2, 2, 3, 3, 3, 3, 3, 1, 2, 2, 2, 3, 5, 3, 1, 3, 1, 1, 2, 3, 2, 3, 1, 3, 3, 1, 2, 3, 2, 67},
        {3, 3, 67, 2, 1, 1, 3, 515, 1, 2, 67, 2, 3, 2, 2, 1, 2, 2, 67, 2, 3, 2, 1, 3, 2, 3, 2, 3, 2, 2, 515, 1, 2, 2, 1, 2, 1, 2, 1, 3, 3, 3, 2},
        {2, 3, 2, 2, 1, 2, 2, 3, 515, 3, 3, 7, 1, 3, 515, 1, 1, 2, 1, 2, 2, 1, 3, 2, 3, 2, 3, 3, 7, 2, 3, 67, 1, 1, 3, 2, 2, 3, 5, 3, 3, 2, 3},
        {3, 1, 3, 2, 1, 2, 2, 2, 3, 3, 5, 1, 1, 3, 3, 2, 3, 1, 1, 1, 2, 3, 1, 2, 3, 2, 1, 1, 1, 3, 3, 3, 3, 35, 1, 3, 3, 3, 1, 3, 1, 3, 11},
        {2, 1, 3, 1, 1, 2, 515, 1, 3, 1, 2, 1, 19, 3, 1, 3, 1, 1, 2, 3, 1, 3, 1, 1, 2, 3, 2, 2, 1, 3, 2, 3, 2, 1, 2, 3, 2, 3, 259, 1, 11, 1, 3},
        {1, 2, 1, 1, 1, 1, 3, 1, 2, 3, 2, 2, 3, 1, 2, 2, 1, 3, 259, 3, 1, 2, 3, 2, 2, 2, 1, 1, 2, 2, 3, 1, 2, 1, 2, 2, 1, 3, 1, 3, 35, 1, 2},
        {1, 3, 3, 1, 1, 3, 2, 1, 2, 3, 1, 3, 2, 2, 1, 1, 2, 2, 2, 2, 3, 2, 2, 2, 3, 1, 259, 1, 2, 3, 3, 3, 3, 1, 3, 1, 3, 1, 1, 3, 3, 3, 3},
        {3, 3, 1, 3, 2, 2, 3, 1, 1, 1, 35, 1, 1, 35, 1, 2, 19, 2, 2, 2, 2, 3, 1, 1, 3, 2, 3, 3, 1, 3, 3, 1, 3, 2, 2, 3, 2, 2, 1, 1, 2, 2, 3},
        {2, 3, 1, 11, 67, 1, 11, 515, 2, 7, 2, 1, 1, 3, 1, 1, 5, 3, 2, 2, 259, 3, 1, 5, 2, 2, 11, 3, 2, 3, 2, 3, 3, 2, 515, 131, 2, 2, 3, 1, 1, 3, 1},
        {2, 1, 5, 1, 1, 3, 2, 3, 2, 3, 3, 3, 3, 3, 2, 1, 1, 1, 1, 1, 2, 2, 3, 1, 1, 3, 2, 2, 1, 3, 3, 3, 3, 1, 1, 1, 3, 3, 3, 3, 3, 3, 2},
        {2, 3, 1, 1, 2, 2, 2, 1, 2, 3, 1, 11, 1, 3, 1, 2, 3, 1, 1, 1, 1, 3, 2, 3, 2, 2, 3, 19, 1, 3, 2, 3, 3, 7, 3, 11, 515, 1, 3, 1, 7, 1, 1},
        {1, 1, 1, 2, 1, 1, 3, 2, 2, 2, 2, 1, 2, 3, 1, 1, 3, 2, 3, 2, 1, 1, 3, 2, 2, 3, 3, 1, 3, 3, 2, 2, 1, 2, 3, 2, 1, 1, 1, 2, 2, 1, 3},
        {3, 2, 1, 2, 3, 3, 2, 2, 3, 2, 3, 1, 3, 1, 2, 2, 1, 3, 2, 515, 131, 2, 2, 2, 1, 67, 3, 1, 19, 1, 3, 1, 2, 2, 3, 3, 3, 1, 2, 259, 1, 3, 3},
        {1, 2, 515, 2, 3, 1, 2, 3, 2, 2, 3, 3, 1, 1, 3, 2, 3, 1, 2, 3, 1, 2, 3, 1, 3, 3, 3, 1, 2, 2, 1, 1, 3, 2, 1, 3, 3, 2, 1, 3, 259, 3, 2},
        {3, 3, 2, 2, 1, 1, 1, 2, 2, 2, 19, 2, 3, 3, 3, 3, 2, 2, 3, 2, 1, 3, 2, 3, 515, 1, 2, 3, 1, 1, 3, 1, 3, 2, 3, 2, 3, 1, 2, 2, 2, 1, 3},
        {3, 515, 3, 2, 2, 3, 2, 67, 2, 1, 1, 2, 2, 3, 1, 1, 3, 2, 3, 3, 1, 3, 35, 2, 1, 1, 19, 1, 1, 1, 2, 19, 3, 2, 2, 1, 2, 3, 1, 3, 3, 3, 1},
        {3, 3, 3, 2, 1, 3, 1, 2, 1, 1, 2, 19, 3, 2, 2, 5, 1, 3, 1, 2, 1, 7, 3, 1, 515, 2, 2, 3, 3, 1, 3, 3, 7, 3, 3, 1, 1, 3, 1, 2, 1, 1, 1},
        {2, 3, 2, 3, 3, 2, 7, 2, 2, 2, 1, 2, 2, 3, 2, 1, 3, 1, 19, 3, 3, 67, 3, 3, 1, 3, 1, 1, 1, 3, 1, 1, 3, 1, 1, 3, 1, 3, 1, 1, 3, 5, 3},
        {3, 3, 1, 2, 3, 3, 259, 2, 2, 259, 3, 1, 1, 3, 3, 3, 3, 1, 2, 3, 2, 1, 1, 1, 2, 1, 2, 1, 3, 1, 2, 3, 3, 1, 3, 3, 1, 1, 3, 3, 2, 3, 3},
        {1, 1, 2, 2, 3, 2, 2, 3, 3, 1, 2, 2, 3, 2, 3, 1, 3, 1, 1, 2, 515, 1, 1, 3, 1, 1, 1, 3, 2, 3, 1, 2, 1, 5, 1, 2, 1, 3, 131, 2, 2, 259, 3},
        {2, 2, 2, 7, 259, 1, 2, 259, 2, 3, 2, 3, 1, 35, 5, 1, 7, 3, 131, 1, 2, 1, 1, 3, 1, 3, 2, 2, 3, 2, 1, 3, 1, 1, 1, 1, 1, 3, 2, 19, 3, 3, 3},
        {3, 3, 2, 3, 3, 2, 3, 1, 1, 2, 3, 67, 2, 2, 2, 3, 2, 3, 2, 1, 2, 3, 131, 3, 1, 1, 1, 2, 1, 3, 1, 2, 1, 3, 3, 2, 11, 3, 1, 3, 1, 1, 3},
        {3, 3, 1, 2, 1, 1, 2, 1, 3, 3, 3, 3, 3, 3, 1, 3, 7, 2, 3, 2, 1, 1, 2, 1, 2, 1, 3, 2, 1, 1, 1, 2, 1, 2, 11, 3, 1, 131, 2, 1, 1, 1, 1},
        {3, 1, 1, 19, 1, 2, 2, 2, 2, 1, 2, 2, 2, 2, 3, 3, 3, 3, 1, 1, 1, 2, 1, 2, 1, 1, 3, 3, 3, 1, 3, 2, 1, 3, 1, 3, 2, 2, 1, 2, 3, 3, 259},
        {3, 1, 2, 2, 1, 1, 1, 2, 1, 2, 2, 1, 131, 1, 3, 1, 2, 3, 1, 3, 1, 2, 2, 1, 3, 2, 2, 1, 2, 2, 515, 3, 1, 1, 1, 2, 2, 3, 2, 1, 3, 1, 2},
        {2, 2, 2, 2, 1, 1, 1, 1, 1, 2, 2, 3, 1, 3, 3, 1, 259, 3, 3, 2, 1, 3, 2, 1, 2, 1, 1, 1, 1, 3, 2, 1, 1, 515, 3, 11, 3, 5, 2, 1, 5, 2, 3},
        {1, 1, 2, 2, 3, 19, 3, 2, 3, 1, 2, 2, 2, 3, 2, 1, 2, 3, 2, 11, 1, 3, 2, 3, 1, 1, 1, 3, 3, 3, 1, 2, 3, 1, 3, 1, 1, 2, 2, 3, 2, 515, 3}
    };
    
    
    vector<pair<int, int>> cpures;
    MazeRouter mazeRouter;
    auto cputime = mazeRouter.route(h_matrix, N, pins, cpures);
    //show the path
    cout << "Original maze route Path: ";
    for (auto [r, c] : cpures) {
        cout << "(" << r << "," << c << ") ";
    }
    cout << endl;
    cout << "Cost is " << evaluate(cpures, h_matrix, N);
    cout << endl;
    TimeProfile t;
    DazeRouter dazeRouter;
    vector<pair<int, int>> dres;
    auto dTime = dazeRouter.route(h_matrix, N, pins, dres, &t);
    // Print the final cost and the path selected
    cout << "The final cost is " << evaluate(dres, h_matrix, N) << ". " << endl;
    cout << "The final path is " << endl;
     //show the path
    cout << "Path: ";
    for (auto [r, c] : dres) {
        cout << "(" << r << "," << c << ") ";
    }
    assert(checkAllPinsOnPath(dres, pins));
    cout << endl;
    cout << endl;
    
}